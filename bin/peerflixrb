#!/usr/bin/env ruby
$LOAD_PATH.unshift File.join(File.dirname(__FILE__), *%w( .. lib ))

require 'optparse'
require 'peerflixrb'

options = {
  language: 'en',
  video_player: 'vlc'
}

optparse = OptionParser.new do |opts|
  opts.banner = 'Usage: peerflixrb [options] <search>'

  opts.on('-s', '--find-subtitles', 'Find subtitles on Addic7ed') do |s|
    options[:find_subtitles] = s
  end

  opts.on('-n', '--no-player', "Don't autoplay") do
    options[:video_player] = nil
  end

  opts.on('-m', '--mplayer', 'Autoplay in mplayer*') do
    options[:video_player] = 'mplayer'
  end

  opts.on('-t SUBTITLE_FILE', '--subtitles SUBTITLE_FILE', 'Use local subtitles') do |t|
    options[:subtitles] = t
  end

  opts.on('-l LANGUAGE', '--language LANGUAGE', 'Language code to look subtitles for (default: English)') do |l|
    options[:language] = l
  end

  opts.on('-v', '--version', 'Print version and exit') do
    puts "Peerflixrb v#{Peerflixrb::VERSION}"
    exit
  end

  opts.on_tail('-h', '--help', 'Show this message') do
    puts opts
    puts '* Autoplay can take several seconds to start since it needs to wait for the first piece'
    exit
  end
end

optparse.parse!

# Join arguments to create the search term
options[:search] = ARGV.join(' ')

# Show usage if no search
if options[:search].empty?
  puts optparse
  puts '* Autoplay can take several seconds to start since it needs to wait for the first piece'
  exit
end

# main
# TODO: handle failing and invalid searches
kat = Peerflixrb::KAT.new(options[:search])
cache_dir = "/tmp/torrent-stream/#{kat.info_hash}"

# Subtitle search
sub_file = if options[:find_subtitles]
             Peerflixrb.find_subtitles(kat.filename, options[:language])
           elsif options[:subtitles]
             options[:subtitles]
           end

# Was there a problem with the subtitle?
if options[:find_subtitles] && sub_file.nil?
  puts 'Do you want to continue? [Y/n]'
  response = $stdin.gets.chomp.downcase
  exit if response == 'n' || response == 'no'
end

# Peerflix command build
command = "peerflix '#{kat.magnet}'"
command << " --subtitles '#{sub_file}'" if sub_file
command << " --#{options[:video_player]}" if options[:video_player]
command << ' -- --fullscreen'

begin
  # Execute peerflix
  system command
rescue Interrupt
  puts
  puts 'Interrupted!'
ensure
  # Cleaning up
  video_file = Dir["#{cache_dir}/**/*.{mkv,mp4,avi,wmv,mpg,flv,mov}"].first
  FileUtils.mv(sub_file, File.dirname(video_file)) if sub_file
  puts "Your downloads will be in #{cache_dir} for 3 days :)"
end
